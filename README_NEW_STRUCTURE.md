# MedTech API - Новая структура проекта

## Обзор

Проект был реорганизован согласно современным практикам разработки FastAPI приложений. Новая структура обеспечивает лучшую организацию кода, масштабируемость и поддержку.

## Структура проекта

```
backend/
├── app/                     # Главная папка приложения
│   ├── __init__.py
│   ├── main.py             # Инициализация FastAPI приложения
│   ├── database.py         # Конфигурация базы данных
│   ├── settings.py         # Настройки приложения
│   ├── middlewares.py      # Middleware компоненты
│   │
│   ├── routers/            # API эндпоинты
│   │   ├── __init__.py
│   │   └── endpoints.py    # Основные роутеры
│   │
│   ├── models/             # Модели базы данных и Pydantic
│   │   ├── __init__.py
│   │   ├── database.py     # SQLAlchemy модели
│   │   └── llm.py          # LLM модели
│   │
│   ├── schemas/            # Схемы запросов и ответов
│   │   ├── __init__.py
│   │   └── blood_results.py # Схемы для анализов крови
│   │
│   ├── services/           # Основные сервисы
│   │   ├── __init__.py
│   │   ├── qdrant.py       # Сервис векторной БД
│   │   ├── postgres.py     # Сервис PostgreSQL
│   │   ├── llm.py          # Сервис языковых моделей
│   │   ├── document_processor.py
│   │   ├── sii_calculator.py
│   │   ├── lab_parsers.py
│   │   ├── ocr_aws.py
│   │   ├── helper.py
│   │   └── sii_category.py
│   │
│   ├── utils/              # Вспомогательные функции
│   │   ├── __init__.py
│   │   └── helpers.py      # Общие утилиты
│   │
│   └── core/               # Основные компоненты
│       ├── __init__.py
│       ├── config.py       # Конфигурация
│       └── exceptions.py   # Исключения
│
├── docker-compose.yml      # Docker Compose конфигурация
├── Dockerfile             # Docker образ
├── requirements.txt       # Python зависимости
├── .env                   # Переменные окружения
└── README.md             # Документация
```

## Ключевые изменения

### 1. Организация сервисов

Все сервисы теперь организованы в папке `app/services/` с четким разделением ответственности:

- **qdrant.py** - Работа с векторной базой данных Qdrant
- **postgres.py** - Работа с PostgreSQL базой данных
- **llm.py** - Интеграция с языковыми моделями (OpenAI, etc.)
- **document_processor.py** - Обработка документов
- **sii_calculator.py** - Расчет SII индекса

### 2. Модели базы данных

Созданы SQLAlchemy модели в `app/models/database.py`:

- **BloodTestRecord** - Результаты анализов крови
- **UserProfile** - Профили пользователей
- **AnalysisSession** - Сессии анализа документов
- **SystemLog** - Системные логи

### 3. Конфигурация базы данных

Файл `app/database.py` содержит:
- Асинхронное подключение к PostgreSQL
- Управление сессиями
- Инициализация таблиц

### 4. Docker Compose

Новый `docker-compose.yml` включает:
- FastAPI приложение
- PostgreSQL база данных
- Qdrant векторная база
- Redis для кэширования

## Запуск проекта

### Локальная разработка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте переменные окружения в `.env`:
```env
DATABASE_URL=postgresql://postgres:password@localhost:5432/medtech
OPENAI_API_KEY=your_openai_api_key
OPENAI_ORGANIZATION=your_openai_org
```

3. Запустите приложение:
```bash
uvicorn app.main:app --reload
```

### Docker Compose

1. Запустите все сервисы:
```bash
docker-compose up -d
```

2. Приложение будет доступно по адресу: http://localhost:8000

## API Эндпоинты

- `GET /` - Корневой эндпоинт
- `POST /parse-blood-test` - Парсинг файла с анализом крови
- `POST /blood-results` - Расчет SII индекса
- `GET /health` - Проверка состояния API

## Сервисы

### QdrantService

Сервис для работы с векторной базой данных:
- Создание коллекций
- Вставка векторов
- Поиск похожих векторов

### PostgresService

Сервис для работы с PostgreSQL:
- Управление соединениями
- Выполнение запросов
- Сохранение результатов анализов

### LLMService

Сервис для работы с языковыми моделями:
- Генерация текста
- Анализ результатов крови
- Медицинские рекомендации

## Миграция с старой структуры

Основные изменения в импортах:
- `src.` → `app.`
- Все сервисы теперь в `app.services.`
- Модели в `app.models.`
- Схемы в `app.schemas.`

## Преимущества новой структуры

1. **Масштабируемость** - Четкое разделение компонентов
2. **Поддержка** - Легче найти и изменить код
3. **Тестирование** - Проще писать unit тесты
4. **Docker** - Готовая контейнеризация
5. **Базы данных** - Поддержка PostgreSQL и Qdrant
6. **Мониторинг** - Системные логи и метрики

## Следующие шаги

1. Обновить тесты под новую структуру
2. Добавить миграции базы данных
3. Настроить CI/CD пайплайн
4. Добавить мониторинг и логирование
5. Документировать API с помощью OpenAPI 